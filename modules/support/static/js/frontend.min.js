"use strict";!function(d){var a="zoiaTable",i={limit:10,maxPages:7,html:{spinnerHTML:'<div style="width:40px;height:40px;background-color:#333;-webkit-animation:sk-rotateplane 1.2s infinite ease-in-out;animation: sk-rotateplane 1.2s infinite ease-in-out;margin: auto;position: absolute;top:0;left:0;bottom:0;right:0"></div>',spinnerWrapCSS:"background:#fff;position:absolute;opacity:0.6",headCSS:"@-webkit-keyframes sk-rotateplane{0%{-webkit-transform:perspective(120px)}50%{-webkit-transform:perspective(120px) rotateY(180deg)}100%{-webkit-transform:perspective(120px) rotateY(180deg) rotateX(180deg)}}@keyframes sk-rotateplane{0%{transform:perspective(120px) rotateX(0deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(0deg) rotateY(0deg)}50%{transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg);-webkit-transform:perspective(120px) rotateX(-180.1deg) rotateY(0deg)}100%{transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg);-webkit-transform:perspective(120px) rotateX(-180deg) rotateY(-179.9deg)}}",listWrapStartHTML:'<ul class="za-pagination" za-margin>',listWrapEndHTML:"</ul>",itemPagePrevHTML:'<li><a href="#"><a class="zoia-page {elementId}PaginationLink" data-page="{page}"><span za-pagination-previous></span></a></li>',itemPageNextHTML:'<li><a href="#"><a class="zoia-page {elementId}PaginationLink" data-page="{page}"><span za-pagination-next></span></a></li>',itemPageHTML:'<li><a class="zoia-page {elementId}PaginationLink" data-page="{page}">{page}</a></li>',itemPageDotsHTML:'<li class="za-disabled"><span>...</span></li>',arrowDown:"&nbsp;&#x25BC;",arrowUp:"&nbsp;&#x25B2;",errorHTML:'<tr><td colspan="100%">{error}</td></tr>'},lang:{error:"Could not load data from server. Please try to refresh page in a few moments.",noitems:"No items to display"},sort:{},loadOnStart:!0,onLoad:function(){}};function s(t,e){this.element=t,this.settings=d.extend({},i,e),this._defaults=i,this._name=a,this.page=1,this.loading=!1,this.search="",this.currentData={},this.init()}d.extend(s.prototype,{init:function(){var e=this;d("head").append('<style type="text/css">'+this.settings.html.headCSS+"</style>"),d(this.element).before('<div style="'+this.settings.html.spinnerWrapCSS+'" id="'+this.element.id+'LoadingDiv">'+this.settings.html.spinnerHTML+"</div>"),this._loading(!1),this.header=[];for(var t=0;t<d("#"+this.element.id+" > thead > tr").children("th").length;t++){var a=d("#"+this.element.id+" > thead > tr").children("th")[t];if(a.id){this.header.push(a.id);var i=a.id.replace(new RegExp("^"+this.element.id+"_"),"");this.settings.fields[i]&&this.settings.fields[i].sortable&&(d(a).css("cursor","pointer"),d(a).click(function(t){e._sortColumn(t)}))}}d("."+this.element.id+"SearchInput").keypress(e._debounce(function(t){e._search(t)},250)),d("."+this.element.id+"SearchInputClear").click(function(t){e._searchReset(t)}),this.settings.loadOnStart&&this.load()},_search:function(t){this.loading||(this.search=d(t.target).val().trim(),this.page=1,this.load())},_searchReset:function(){this.loading||(d("."+this.element.id+"SearchInput").val("").focus(),this.search="",this.page=1,this.load())},_sortIndicator:function(t,e){d("#"+this.element.id+"SortingIndicator").remove();for(var a="desc"===e?this.settings.html.arrowDown:this.settings.html.arrowUp,i=0;i<d("#"+this.element.id+" > thead > tr").children("th").length;i++){var s=d("#"+this.element.id+" > thead > tr").children("th")[i];s.id===this.element.id+"_"+t&&d(s).html(d(s).html()+'<span class="zoiaTableSortingIndicator" id="'+this.element.id+'SortingIndicator">'+a+"</span>")}},_sortColumn:function(t){if(t.preventDefault(),t.target.id&&t.target.id!==this.element.id+"SortingIndicator"){var e=t.target.id.replace(new RegExp("^"+this.element.id+"_"),"");this.settings.sort.field===e?this.settings.sort.direction="asc"===this.settings.sort.direction?"desc":"asc":(this.settings.sort.field=e,this.settings.sort.direction="asc"),this.load()}},_template:function(t,e){for(var a in e)t=t.replace(new RegExp("{"+a+"}","g"),e[a]);return t},_bindSelectButtons:function(){var t=this;d("."+this.element.id+"BtnSelectAll").click(function(){t._selectAll()}),d("."+this.element.id+"BtnSelectNone").click(function(){t._selectNone()})},_selectAll:function(){this.loading||d("."+this.element.id+"Checkbox").prop("checked",!0)},_selectNone:function(){this.loading||d("."+this.element.id+"Checkbox").prop("checked",!1)},_pagination:function(){var e=this,t=this.settings.maxPages,a=Math.ceil(this.total/this.settings.limit);if(a<2)d("."+this.element.id+"Pagination").html("");else{var i=this.settings.html.listWrapStartHTML;if(t<a){1<this.page&&(i+=this._template(this.settings.html.itemPagePrevHTML,{elementId:this.element.id,page:this.page-1})),3<this.page&&(i+=this._template(this.settings.html.itemPageHTML,{elementId:this.element.id,page:1}));var s=this.page-2;s<1&&(s=1),1<s-1&&(i+=this.settings.html.itemPageDotsHTML);var n=this.page+2;a<n&&(n=a);for(var o=s;o<=n;o++)i+=this._template(this.settings.html.itemPageHTML,{elementId:this.element.id,page:o});n<a-1&&(i+=this.settings.html.itemPageDotsHTML),this.page<=a-3&&(i+=this._template(this.settings.html.itemPageHTML,{elementId:this.element.id,page:a})),this.page<a&&(i+=this._template(this.settings.html.itemPageNextHTML,{elementId:this.element.id,page:this.page+1}))}else for(var r=1;r<=a;r++)i+=this._template(this.settings.html.itemPageHTML,{elementId:this.element.id,page:r});i+=this.settings.html.listWrapEndHTML,d("."+this.element.id+"Pagination").html(i),d("."+this.element.id+"PaginationLink").click(function(){var t=parseInt(d(this).data("page"),10);e.loading||e.page===t||(e.page=t,e.load())})}},_loading:function(t){var e="#"+this.element.id+"LoadingDiv";d(e).css({top:d(this.element).top,left:d(this.element).left,width:d(this.element).outerWidth(!0),height:d(this.element).outerHeight(!0)}),t?this.loadingInt=setTimeout(function(){d(e).show()},300):(clearTimeout(this.loadingInt),d(e).hide())},_debounce:function(a,i){var s=null;return function(){var t=this,e=arguments;clearTimeout(s),s=setTimeout(function(){a.apply(t,e)},i)}},getCurrentData:function(){return this.currentData},load:function(){if(this.settings.url&&!this.loading){var r=this,l="";this._loading(!0),this.loading=!0,d.ajax({type:"GET",url:this.settings.url,data:{limit:this.settings.limit,skip:this.page*this.settings.limit-this.settings.limit,sortField:this.settings.sort.field,sortDirection:this.settings.sort.direction,search:this.search},cache:!1}).done(function(t){if(r.loading=!1,t){for(var e in r.pages=parseInt(t.total/r.settings.limit,10),0<t.total%r.settings.limit&&r.pages++,r.total=t.total,r._pagination(),r.currentData={},t.items){var a=t.items[e];for(var i in r.currentData[a._id]=a,l+="<tr>",r.header)if(r.header[i]===r.element.id+"ID")l+='<td><input type="checkbox" id="'+a._id+'" class="za-checkbox '+r.element.id+'Checkbox"></td>';else{var s=!1,n=r.header[i].replace(new RegExp("^"+r.element.id+"_"),"");for(var o in a)o===n&&r.settings.fields[o]&&(a[o]&&"string"==typeof a[o]&&(a[o]=a[o].replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),l+="<td>"+r.settings.fields[o].process(o,a,a[o])+"</td>",s=!0);s||(r.settings.fields[n]&&r.settings.fields[n].process?l+="<td>"+r.settings.fields[n].process(n,a)+"</td>":l+="<td></td>")}l+="</tr>"}d(r.element).find("tbody").html(l.length?l:r._template(r.settings.html.errorHTML,{error:r.settings.lang.noitems})),r._loading(!1),d('*[data-page="'+r.page+'"]').parent().addClass("za-active"),r._bindSelectButtons(),r.settings.sort.field&&r._sortIndicator(r.settings.sort.field,r.settings.sort.direction),d(r.element).find("thead").show(),r.settings.onLoad()}else r.loading=!1,r._loading(!1),d(r.element).find("tbody").html(r._template(r.settings.html.errorHTML,{error:r.settings.lang.error}))}).fail(function(){r.loading=!1,r._loading(!1),d(r.element).find("tbody").html(r._template(r.settings.html.errorHTML,{error:r.settings.lang.error}))})}}}),d.fn[a]=function(t){var e=void 0;return this.each(function(){(e=d.data(this,"plugin_"+a))||(e=new s(this,t),d.data(this,"plugin_"+a,e))}),e}}(jQuery,window,document);var currentSupportRequestID=void 0,supportMessageDialog=void 0,captchaRefresh=function(){$(".zoia-ct-captcha-img").attr("src","/api/captcha?rnd="+Math.random()),$("#zoia_ct_captcha").val(""),$(".zoia-ct-captcha-img").show()},createTicketFormSubmit=function(t){t.preventDefault();var e=$("#zoia_ct_title").val().trim(),a=$("#zoia_ct_message").val().trim(),i=parseInt($("#zoia_ct_priority").val()),s=$("#zoia_ct_captcha").val().trim();return $(".zoia-ct-field").removeClass("za-form-danger"),$("#zoia_ct_form_error").hide(),!e||e.length<2||128<e.length?($("#zoia_ct_form_error").show(),$("#zoia_ct_title").focus().addClass("za-form-danger")):!a||a.length<2||4096<a.length?($("#zoia_ct_form_error").show(),$("#zoia_ct_message").focus().addClass("za-form-danger")):s&&s.match(/^[0-9]{4}$/)?($("#zoia_ct_btn_create_spinner").show(),void $.ajax({type:"POST",url:"/api/support/frontend/create",cache:!1,data:{title:e,message:a,priority:i,captcha:s}}).done(function(t){$("#zoia_ct_btn_create_spinner").hide(),t&&1===t.status?(window.history.pushState({action:"view",id:t.id},document.title,"/support?action=view&id="+t.id),viewTicket(String(t.id))):(captchaRefresh(),t.captcha&&$("#zoia_ct_captcha").focus().addClass("za-form-danger"),$zUI.notification(t.error?t.error:lang["Error while loading data"],{status:"danger",timeout:1500}))}).fail(function(){captchaRefresh(),$("#zoia_ct_btn_create_spinner").hide(),$zUI.notification(lang["Error while loading data"],{status:"danger",timeout:1500})},200)):($("#zoia_ct_form_error").show(),$("#zoia_ct_captcha").focus().addClass("za-form-danger"))},getUrlParam=function(t){var e=decodeURIComponent(window.location.search.substring(1)).split("&"),a=void 0,i=void 0;for(i=0;i<e.length;i++)if((a=e[i].split("="))[0]===t)return void 0===a[1]||a[1]},deleteAttachment=function(t,e){$('.zoia-attachment-delete[data-fid="'+e+'"]').parent().hide(),$.ajax({type:"POST",url:"/api/support/frontend/attachment/delete",cache:!1,data:{id:t,fid:e}}).done(function(t){t&&1===t.status?$('.zoia-attachment-delete[data-fid="'+e+'"]').parent().remove():($('.zoia-attachment-delete[data-fid="'+e+'"]').parent().show(),$zUI.notification(lang["Error while loading data"],{status:"danger",timeout:1500}))}).fail(function(){$('.zoia-attachment-delete[data-fid="'+e+'"]').parent().show(),$zUI.notification(lang["Error while loading data"],{status:"danger",timeout:1500})},200)},bindDeleteAttachmentHandlers=function(){$(".zoia-attachment-delete").unbind().click(function(){var t=$(this).parent().find("a").html(),e=$(this).attr("data-id"),a=$(this).attr("data-fid");$zUI.modal.confirm(lang["The following file will be deleted. Continue?"]+"<br><br>"+t,{labels:{ok:lang.Yes,cancel:lang.Cancel},stack:!0}).then(function(){deleteAttachment(e,a)})})},viewTicket=function(t){if(!t||!t.match(/^[0-9]{1,10}$/))return $zUI.modal.alert(lang["Invalid Ticket ID."],{labels:{ok:lang.OK}});currentSupportRequestID=t,$(".zoia-wrap-table").hide(),$(".zoia-wrap-new").hide(),$(".zoia-ticket-id").html(t),$(".zoia-ticket-wrap-data").hide(),$(".zoia-ticket-wrap-loading").show(),$(".zoia-wrap-view").show(),$.ajax({type:"GET",url:"/api/support/frontend/load",cache:!1,data:{id:t}}).done(function(t){if(t&&1===t.status){switch($("#support").zoiaTable().load(),$(".zoia-ticket-title").html(t.data.title),$(".zoia-ticket-timestamp").html(new Date(1e3*t.data.timestamp).toLocaleString()),$(".zoia-ticket-status").removeClass("za-label-success").removeClass("za-label-warning"),t.data.status){case 1:$(".zoia-ticket-status").addClass("za-label-warning");break;case 2:$(".zoia-ticket-status").addClass("za-label-success")}t.data.messages&&t.data.messages.sort(function(t,e){return t.timestamp>e.timestamp?-1:e.timestamp>t.timestamp?1:0});var e="";for(var a in t.data.messages){var i="";t.data.messages[a].username!==currentUsername&&(i=" zoia-reply-msg"),e+='<article class="za-comment za-margin za-card za-card-default za-card-small za-card-body'+i+'"><header class="za-comment-header za-grid-medium za-flex-middle" za-grid><div class="za-width-expand""><h4 class="za-comment-title za-margin-remove"><span class="za-link-reset">'+t.data.messages[a].username+'</span></h4><ul class="za-comment-meta za-subnav za-subnav-divider za-margin-remove-top" style="border-bottom:1px solid #ddd"><li><span>'+new Date(1e3*parseInt(t.data.messages[a].timestamp)).toLocaleString()+'</span></li></ul></div></header><div class="za-comment-body"><p class="zoia-msg-text">'+t.data.messages[a].message.replace(/\n/gm,"<br>")+"</p></div></article>"}var s="";for(var n in t.data.files){var o=t.data.files[n];s+='<div><span za-icon="icon:trash" class="zoia-attachment-delete" data-id="'+currentSupportRequestID+'" data-fid="'+o.id+'"></span>&nbsp;<a href="/api/support/download?id='+currentSupportRequestID+"&fid="+o.id+'" target="_blank">'+o.filename+"</a></div>"}$("#zoia_attachments").html(s),bindDeleteAttachmentHandlers(),$(".zoia-ticket-messages").html(e),$(".zoia-ticket-status").html(lang.statuses[t.data.status]),$(".zoia-ticket-wrap-loading").hide(),$(".zoia-ticket-wrap-data").show()}else $(".zoia-wrap-view").hide(),$(".zoia-wrap-table").show(),window.history.go(-1),$zUI.notification(t.error?t.error:lang["Error while loading data"],{status:"danger",timeout:1500})}).fail(function(){$(".zoia-wrap-view").hide(),$(".zoia-wrap-table").show(),window.history.go(-1),$zUI.notification(lang["Error while loading data"],{status:"danger",timeout:1500})},200)},initUploader=function(){var l=document.getElementById("zoia_upload_progressbar");$zUI.upload(".zoia-upload",{url:"/api/support/frontend/upload",multiple:!0,beforeAll:function(){this.params.id=currentSupportRequestID},error:function(){l.setAttribute("hidden","hidden"),$zUI.modal.alert(lang["Could not upload file to server. Please check file name and size, then try again."],{labels:{ok:lang.OK},stack:!0})},loadStart:function(t){l.removeAttribute("hidden"),l.max=t.total,l.value=t.loaded},progress:function(t){l.max=t.total,l.value=t.loaded},loadEnd:function(t){l.max=t.total,l.value=t.loaded},completeAll:function(t){var e={};try{e=JSON.parse(t.response)}catch(t){}if(e.status&&1===e.status){var a="";for(var i in e.files){var s=e.files[i];a+='<div><span za-icon="icon:trash" class="zoia-attachment-delete" data-id="'+currentSupportRequestID+'" data-fid="'+s.id+'"></span>&nbsp;<a href="/api/support/download?id='+currentSupportRequestID+"&fid="+s.id+'" target="_blank">'+s.filename+"</a></div>"}$("#zoia_attachments").html(a),bindDeleteAttachmentHandlers()}else if(e.error){if($zUI.modal.alert(e.error,{labels:{ok:lang.OK},stack:!0}),e.files){var n="";for(var o in e.files){var r=e.files[o];n+='<div><span za-icon="icon:trash" class="zoia-attachment-delete" data-id="'+currentSupportRequestID+'" data-fid="'+r.id+'"></span>&nbsp;<a href="/api/support/download?id='+currentSupportRequestID+"&fid="+r.id+'" target="_blank">'+r.filename+"</a></div>"}$("#zoia_attachments").html(n),bindDeleteAttachmentHandlers()}}else $zUI.modal.alert(lang["Could not upload file to server. Please check file name and size, then try again."],{labels:{ok:lang.OK},stack:!0});setTimeout(function(){l.setAttribute("hidden","hidden")},1e3)}})},btnMessageSaveClickHandler=function(){$(".zoia-md-field").removeClass("za-form-danger");var t=$("#zoia_md_message").val().trim(),e=$("#zoia_md_captcha").val().trim();return!t||t.length<2||4096<t.length?$("#zoia_md_message").addClass("za-form-danger").focus():e&&e.match(/^[0-9]{4}$/)?($(".zoia-md-button").hide(),$("#zoia_btn_message_save_spinner").show(),void $.ajax({type:"POST",url:"/api/support/frontend/message",cache:!1,data:{id:currentSupportRequestID,captcha:e,message:t}}).done(function(t){if($(".zoia-md-button").show(),$("#zoia_btn_message_save_spinner").hide(),t&&1===t.status){$("#zoia_md_captcha").val("");var e='<article class="za-comment za-margin za-card za-card-default za-card-small za-card-body"><header class="za-comment-header za-grid-medium za-flex-middle" za-grid><div class="za-width-expand""><h4 class="za-comment-title za-margin-remove"><span class="za-link-reset">'+t.message.username+'</span></h4><ul class="za-comment-meta za-subnav za-subnav-divider za-margin-remove-top" style="border-bottom:1px solid #ddd"><li><span>'+new Date(1e3*parseInt(t.message.timestamp)).toLocaleString()+'</span></li></ul></div></header><div class="za-comment-body"><p class="zoia-msg-text">'+t.message.message+"</p></div></article>";$(".zoia-ticket-messages").prepend(e),supportMessageDialog.hide()}else t.captcha&&$("#zoia_md_captcha").addClass("za-form-danger").focus(),captchaRefresh(),$("#zoia_md_captcha").val(""),$zUI.notification(t.error?t.error:lang["Error while loading data"],{status:"danger",timeout:1500})}).fail(function(){$(".zoia-md-button").show(),$("#zoia_btn_message_save_spinner").hide(),captchaRefresh(),$("#zoia_md_captcha").val(""),$zUI.notification(lang["Error while loading data"],{status:"danger",timeout:1500})},200)):$("#zoia_md_captcha").addClass("za-form-danger").focus()},processState=function(t){var e=t||{action:getUrlParam("action"),id:getUrlParam("id")};switch(e.action){case"view":viewTicket(e.id);break;case"create":createTicket();break;default:$(".zoia-wrap-new").hide(),$(".zoia-wrap-view").hide(),$(".zoia-wrap-table").show()}},createTicket=function(){$(".zoia-wrap-table").hide(),$(".zoia-wrap-new").show(),$(".zoia-ct-field").val(""),$("#zoia_ct_priority").val(3),$("#zoia_ct_title").focus(),$("#zoia_ct_form_error").hide()};$(document).ready(function(){for(var t in $("#support").zoiaTable({url:"/api/support/frontend/list",limit:10,sort:{field:"_id",direction:"desc"},fields:{_id:{sortable:!0,process:function(t,e,a){return a}},timestamp:{sortable:!0,process:function(t,e,a){return new Date(1e3*parseInt(a,10)).toLocaleString().replace(/\s/gm,"&nbsp;")}},title:{sortable:!0,process:function(t,e,a){return e.unreadUser&&(a='<span class="za-icon-button" za-icon="icon:mail;ratio:0.6" style="background:#FFB03B;color:#fff;width:20px;height:20px;"></span>&nbsp;'+a),a}},status:{sortable:!0,process:function(t,e,a){return lang.statuses[a]}},priority:{sortable:!0,process:function(t,e,a){return lang.priorities[a]?lang.priorities[a].replace(/\s/g,"&nbsp;"):"&ndash;"}},actions:{sortable:!1,process:function(t,e){return e&&"admin"===e.groupname?"&ndash;":'<button class="za-icon-button zoia-support-action-edit-btn" za-icon="icon: pencil" data="'+e._id+'" style="margin-right:5px"></button>'}}},onLoad:function(){$(".zoia-support-action-edit-btn").click(function(){window.history.pushState({action:"view",id:$(this).attr("data")},document.title,"/support?action=view&id="+$(this).attr("data")),viewTicket($(this).attr("data"))})},lang:{error:lang["Could not load data from server. Please try to refresh page in a few moments."],noitems:lang["No items to display"]}}),lang.priorities)$("#zoia_ct_priority").append('<option value="'+t+'">'+lang.priorities[t]+"</option>");captchaRefresh(),$(".zoia-ct-captcha-img").click(captchaRefresh),$("#zoia_ct_btn_cancel").click(function(t){t.preventDefault(),$(".zoia-wrap-new").hide(),$(".zoia-wrap-table").show(),window.history.pushState({action:""},document.title,"/support")}),$(".zoia-btn-create-ticket").click(function(){window.history.pushState({action:"create"},document.title,"/support?action=create"),createTicket()}),$("#zoia_ct_form").submit(createTicketFormSubmit),$(window).bind("popstate",function(t){processState(t.originalEvent.state)}),$(".zoia-loading").hide(),supportMessageDialog=$zUI.modal("#supportMessageDialog",{bgClose:!1,escClose:!1,stack:!0}),$(".zoia-btn-create-msg").click(function(){$(".zoia-md-field").removeClass("za-form-danger").val(""),supportMessageDialog.show().then(function(){$("#zoia_md_message").focus()})}),$("#zoia_btn_message_save").click(btnMessageSaveClickHandler),$(".zoia-breadcrumb-root").click(function(t){t.preventDefault(),window.history.pushState({action:""},document.title,"/support"),$(".zoia-wrap-new").hide(),$(".zoia-wrap-view").hide(),$(".zoia-wrap-table").show()}),initUploader(),processState()});